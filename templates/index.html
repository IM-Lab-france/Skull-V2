<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Skull Player</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='SkullPlayer.png') }}" />
</head>

<body class="theme-halloween">
    <header class="site-header">
        <div class="site-header-main">
            <div class="site-title">
                <h1>Skull Player</h1>
                <p class="subtitle">Donnez vie à votre Skull
                </p>
            </div>
            <div class="connection-banner" aria-live="polite">
                <div class="header-volume connection-chip connection-chip--secondary" role="group"
                    aria-label="Volume Bluetooth">
                    <button class="header-mute-btn" type="button" data-volume-action="mute" aria-label="Couper le son">
                        <span class="header-mute-icon" aria-hidden="true">&#128263;</span>
                        <span class="header-mute-label">Mute</span>
                    </button>
                    <div class="header-volume-slider">
                        <label class="sr-only" for="volumeSlider">Niveau Bluetooth</label>
                        <input id="volumeSlider" class="volume-slider-input" type="range" min="0" max="127" value="0"
                            step="1" />
                        <span id="volumeSliderValue" class="volume-slider-value header-volume-value"
                            aria-live="polite">0</span>
                    </div>
                </div>
                <div id="connectionStatus" class="connection-chip offline" role="status">
                    <span id="connectionStatusDot" class="connection-dot" aria-hidden="true"></span>
                    <span id="connectionStatusText" class="connection-label">Skull : inconnu</span>
                </div>
                <div id="bluetoothTopStatus" class="connection-chip connection-chip--secondary unknown" role="status">
                    <span id="bluetoothTopStatusDot" class="connection-dot" aria-hidden="true"></span>
                    <span id="bluetoothTopStatusText" class="connection-label">Bluetooth : inconnu</span>
                </div>
                <div id="esp32TopStatus" class="connection-chip connection-chip--secondary disabled" role="status">
                    <span id="esp32TopStatusDot" class="connection-dot" aria-hidden="true"></span>
                    <span id="esp32TopStatusText" class="connection-label">ESP32 : inactif</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="layout">
            <section class="card playback-card" id="sessions">
                <header class="card-header">
                    <h2>Contrôles de lecture</h2>
                </header>

                <div class="playback-select">
                    <label class="label" for="sessionSelect">Sessions disponibles</label>
                    <div class="session-select-row">
                        <select id="sessionSelect" class="select"></select>
                        <button id="refreshBtn" class="btn secondary icon-only" type="button"
                            title="Actualiser les sessions" aria-label="Actualiser les sessions">&#8635;</button>
                    </div>
                </div>

                <div class="controls-inline" role="group" aria-label="Contrôles de lecture">
                    <button id="playBtn" class="btn success" type="button">▶ Play</button>
                    <button id="pauseBtn" class="btn warning" type="button">⏸ Pause</button>
                    <button id="resumeBtn" class="btn info" type="button">▶ Resume</button>
                    <button id="stopBtn" class="btn danger" type="button">⏹ Stop</button>
                </div>

                <div class="random-mode">
                    <div class="random-mode-actions">
                        <button id="randomModeToggle" class="btn secondary" type="button" aria-pressed="false">
                            Mode aléatoire : OFF
                        </button>
                        <button id="shuffleAllBtn" class="btn info" type="button">
                            Lecture aléatoire continue
                        </button>
                    </div>
                    <p id="randomModeHint" class="hint" aria-live="polite">
                        Ignorer la sélection et choisir un morceau aléatoire (hors Accueil).
                    </p>
                </div>

                <section class="loop-panel" aria-labelledby="loopTitle">
                    <div class="loop-header">
                        <h3 id="loopTitle">Boucle audio</h3>
                        <p id="loopStatusText" class="loop-status-text">Aucune boucle importee</p>
                    </div>
                    <p class="loop-meta">
                        <span class="label">Fichier actuel :</span>
                        <span id="loopFilename">Aucun MP3</span>
                    </p>
                    <p class="loop-meta" id="loopSelectedRow" hidden>
                        <span class="label">Selection :</span>
                        <span id="loopSelectedName"></span>
                    </p>

                    <!-- AJOUT: slider de volume de la boucle -->
                    <div class="loop-volume-row" role="group" aria-label="Volume boucle">
                        <label for="loopVolumeSlider" class="label">Volume boucle</label>
                        <div class="header-volume-slider">
                            <input id="loopVolumeSlider" class="volume-slider-input" type="range" min="0" max="100"
                                value="0" step="1" />
                            <span id="loopVolumeValue" class="volume-slider-value header-volume-value"
                                aria-live="polite">0%</span>
                        </div>
                        <p class="hint">Règle le niveau de la boucle interne (0–100%).</p>
                    </div>
                    <!-- FIN AJOUT -->

                    <p id="loopResumeHint" class="hint" hidden>La boucle reprendra automatiquement apres la lecture.</p>
                    <div class="loop-actions">
                        <label class="btn secondary">
                            <input id="loopFile" type="file" accept="audio/mpeg,.mp3" hidden />
                            Choisir un MP3
                        </label>
                        <button id="loopUploadBtn" class="btn primary" type="button" disabled
                            data-loading-label="Import...">
                            Importer
                        </button>
                        <button id="loopToggleBtn" class="btn success" type="button" disabled
                            data-label-on="Activer la boucle" data-label-off="Desactiver la boucle">
                            Activer la boucle
                        </button>
                    </div>
                </section>
                <div class="session-danger-zone playback-danger-zone" role="group"
                    aria-label="Suppression de la session sélectionnée">
                    <button id="deleteSessionBtn" class="btn danger" type="button">
                        Supprimer la session sélectionnée
                    </button>
                    <p class="hint">Supprime définitivement le dossier de la session sur le RPi.</p>
                </div>

                <div class="playback-status" role="status" aria-live="polite">
                    <span class="label">Statut lecture</span>
                    <span id="badgeState" class="badge is-idle">IDLE</span>
                </div>
            </section>

            <section class="card playlist-card">
                <header class="card-header">
                    <h2>Playlist</h2>
                </header>
                <div id="playlistCurrent" class="playlist-current" aria-live="polite">
                    Playlist vide
                </div>
                <ul id="playlistList" class="playlist-list" aria-label="Morceaux dans la playlist"></ul>
                <div class="playlist-actions">
                    <button id="playlistRefreshBtn" class="btn secondary" type="button">Actualiser</button>
                    <button id="playlistSkipBtn" class="btn danger" type="button" disabled>Passer</button>
                </div>
            </section>

            <section class="card upload-card">
                <header class="card-header">
                    <h2>Uploader une session</h2>
                </header>
                <details class="accordion-item" open>
                    <summary>Formulaire d&apos;upload</summary>
                    <div class="accordion-content">
                        <form id="uploadForm" class="upload-form" autocomplete="off">
                            <label class="label" for="sceneName">Nom de la sc&egrave;ne</label>
                            <input id="sceneName" class="input" type="text" maxlength="50"
                                placeholder="Nom de la sc&egrave;ne" autocomplete="off" />

                            <div class="picker-row">
                                <button id="btnPickJson" class="btn secondary" type="button">Choisir JSON</button>
                                <button id="btnPickMp3" class="btn secondary" type="button">Choisir MP3</button>
                            </div>

                            <div id="dropzone" class="dropzone" tabindex="0" aria-label="Zone de d&eacute;p&ocirc;t">
                                <div class="dropzone-inner">
                                    <div class="dz-icon">&uarr;</div>
                                    <div class="dz-text">
                                        D&eacute;posez ici votre <strong>JSON</strong> et votre
                                        <strong>MP3</strong><br />
                                        <span class="dz-sub">ou cliquez pour parcourir...</span>
                                    </div>
                                </div>
                            </div>

                            <input id="fileJson" type="file" name="json" accept=".json" hidden />
                            <input id="fileMp3" type="file" name="mp3" accept="audio/mpeg,.mp3" hidden />

                            <div class="file-list" id="fileList">
                                <div class="file-pill" id="pillJson">
                                    JSON : <span class="file-name" data-empty>aucun</span>
                                </div>
                                <div class="file-pill" id="pillMp3">
                                    MP3 : <span class="file-name" data-empty>aucun</span>
                                </div>
                            </div>

                            <button id="btnUpload" class="btn primary" type="submit">Charger l&apos;animation</button>

                            <div id="uploadProgress" class="progress" hidden>
                                <div id="uploadBar" class="bar"></div>
                            </div>
                        </form>
                    </div>
                </details>
            </section>

            <section class="card esp32-card" id="esp32Card">
                <header class="card-header">
                    <h2>Pilotage ESP32</h2>
                </header>
                <div class="esp32-connection">
                    <div class="esp32-status-chip">
                        <span id="esp32StatusDot" class="connection-dot" aria-hidden="true"></span>
                        <span id="esp32StatusText" class="connection-label">Inactif (désactivé)</span>
                    </div>
                    <button id="esp32StatusRefreshBtn" class="btn secondary" type="button">
                        Tester la connexion
                    </button>
                </div>

                <form id="esp32ConfigForm" class="esp32-form" autocomplete="off">
                    <div class="esp32-form-grid">
                        <label>
                            <span>Hôte</span>
                            <input id="esp32Host" class="input" type="text" placeholder="SkullHard.local" />
                        </label>
                        <label>
                            <span>Port</span>
                            <input id="esp32Port" class="input" type="number" min="1" step="1" value="80" />
                        </label>
                        <label class="esp32-toggle">
                            <input id="esp32Enabled" type="checkbox" />
                            <span>Activer le pilotage</span>
                        </label>
                    </div>
                    <button id="esp32ConfigSaveBtn" class="btn primary" type="submit">Enregistrer</button>
                </form>

                <div class="esp32-buttons-group" role="group" aria-label="Commandes ESP32">
                    <button id="esp32RelayOnBtn" class="btn success" type="button">Relais ON</button>
                    <button id="esp32RelayOffBtn" class="btn secondary" type="button">Relais OFF</button>
                    <button id="esp32AutoRelayToggle" class="btn info" type="button" aria-pressed="false">
                        Auto-relay
                    </button>
                </div>

                <div class="esp32-status-panel">
                    <h3 class="esp32-subtitle">État courant</h3>
                    <div class="esp32-status-grid">
                        <div>
                            <span class="label">Relais</span>
                            <span id="esp32RelayState" class="badge">-</span>
                        </div>
                        <div>
                            <span class="label">Mode auto</span>
                            <span id="esp32AutoRelayState" class="badge">-</span>
                        </div>
                        <div>
                            <span class="label">Session</span>
                            <span id="esp32CurrentSession">-</span>
                        </div>
                        <div>
                            <span class="label">Wi-Fi</span>
                            <span id="esp32WifiInfo">-</span>
                        </div>
                    </div>
                    <pre id="esp32StatusRaw" class="status-box esp32-status-raw" aria-live="polite"></pre>
                </div>
            </section>

            <section class="card session-management-card">
                <header class="card-header">
                    <h2>Gestion des boutons</h2>
                </header>
                <details class="accordion-item">
                    <summary>Boutons physiques ESP32</summary>
                    <div class="accordion-content">
                        <div class="esp32-buttons-header">
                            <span class="esp32-subtitle">Associer les catégories</span>
                            <button id="esp32ButtonsRefreshBtn" class="btn secondary" type="button">
                                Actualiser
                            </button>
                        </div>
                        <div id="esp32ButtonsContainer" class="esp32-buttons-grid" role="group"
                            aria-label="Association boutons ESP32"></div>
                        <p class="hint">
                            Choisissez une catégorie pour chaque bouton (1 à 3). Sélectionnez
                            &laquo;&nbsp;-- Aucun --&nbsp;&raquo; pour vider l'association.
                        </p>
                    </div>
                </details>

                <details class="accordion-item" open>
                    <summary>Catégories des morceaux</summary>
                    <div class="accordion-content">
                        <div id="categoryManager" class="category-manager">
                            <p class="hint">
                                Assignez une catégorie à chaque session ou ajoutez-en une nouvelle.
                            </p>
                            <div class="category-actions" role="group" aria-label="Gestion des catégories">
                                <label class="label category-label" for="categoryAddInput">Nouvelle catégorie</label>
                                <div class="category-actions-controls">
                                    <input id="categoryAddInput" class="input" type="text" maxlength="64"
                                        placeholder="Ex&nbsp;: Enfant" autocomplete="off" />
                                    <button id="categoryAddBtn" class="btn info" type="button">Ajouter</button>
                                </div>
                                <p id="categoryManagerStatus" class="hint category-status" role="status"
                                    aria-live="polite"></p>
                            </div>
                            <div id="categoryManagerList" class="category-list" role="list"></div>
                        </div>
                    </div>
                </details>
            </section>

            <section class="card bt-pairing-card">
                <header class="card-header">
                    <h2>Appairage Bluetooth</h2>
                    <button id="btScanBtn" class="btn secondary" type="button">Scanner</button>
                </header>
                <div class="row">
                    <label class="label" for="btDeviceSelect">Périphériques détectés</label>
                    <select id="btDeviceSelect" class="select" aria-label="Périphériques détectés"></select>
                </div>
                <div class="controls-inline" role="group" aria-label="Appairage Bluetooth">
                    <button id="btPairBtn" class="btn primary" type="button" disabled>Connecter l'enceinte</button>
                </div>
                <p class="hint">Lancez un scan puis sélectionnez votre enceinte.
                </p>
            </section>


        </div>

        <div id="deleteSessionModal" class="modal-overlay hidden" role="dialog" aria-modal="true"
            aria-labelledby="deleteSessionTitle">
            <div class="modal-box">
                <button id="deleteSessionClose" class="modal-close" type="button" aria-label="Fermer">
                    <span aria-hidden="true">&times;</span>
                </button>
                <div class="modal-graphic" aria-hidden="true">🎃</div>
                <h3 id="deleteSessionTitle">Confirmer la suppression</h3>
                <p class="modal-lead">
                    Veux-tu vraiment bannir <strong id="deleteSessionName"></strong>&nbsp;?
                </p>
                <p class="modal-subtext">
                    Le dossier de la session sera définitivement supprimé du RPi.
                </p>
                <p id="deleteSessionMessage" class="modal-status" role="status" aria-live="polite"></p>
                <div class="modal-actions">
                    <button id="deleteSessionCancel" class="btn secondary" type="button">Annuler</button>
                    <button id="deleteSessionConfirm" class="btn danger" type="button">Oui, supprimer</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <small>RPi4 &times; PCA9685 &times; Aucun mode simulation &times; UI par FozzY</small>
    </footer>

    <div id="leftPanel" class="left-panel" aria-hidden="true">
        <div class="left-panel-content">
            <h2>Redémarrages</h2>
            <section class="panel-section">
                <h3>Services</h3>
                <div class="maintenance-actions">
                    <button id="restartBluetoothBtn" class="btn warning" type="button">
                        Redémarrer Bluetooth
                    </button>
                    <button id="restartServiceBtn" class="btn warning" type="button">
                        Redémarrer service servo-sync
                    </button>
                    <button id="esp32RestartBtn" class="btn warning" type="button">
                        Redémarrer ESP32
                    </button>
                </div>
            </section>

            <section class="panel-section advanced-settings-panel">
                <h3>Réglages avancés</h3>
                <details class="accordion-item" open>
                    <summary>Canaux actifs</summary>
                    <div class="accordion-content">
                        <div class="toggle-group">
                            <label class="toggle">
                                <input id="cbEyeLeft" type="checkbox" checked />
                                <span>Œil gauche</span>
                            </label>
                            <label class="toggle">
                                <input id="cbEyeRight" type="checkbox" checked />
                                <span>Œil droit</span>
                            </label>
                            <label class="toggle">
                                <input id="cbNeck" type="checkbox" checked />
                                <span>Cou</span>
                            </label>
                            <label class="toggle">
                                <input id="cbJaw" type="checkbox" checked />
                                <span>Mâchoire</span>
                            </label>
                        </div>
                        <p class="hint">
                            Décochez pour geler un servo. Il conservera alors sa dernière position.
                        </p>
                    </div>
                </details>

                <details class="accordion-item" open>
                    <summary>Ajustements pitch</summary>
                    <div class="accordion-content">
                        <div class="pitch-controls">
                            <div class="pitch-item">
                                <label for="pitchJaw">Mâchoire (°)</label>
                                <input id="pitchJaw" type="range" min="-45" max="45" value="0" />
                                <span class="pitch-value">0°</span>
                            </div>
                            <div class="pitch-item">
                                <label for="pitchEyeLeft">Œil gauche (°)</label>
                                <input id="pitchEyeLeft" type="range" min="-45" max="45" value="0" />
                                <span class="pitch-value">0°</span>
                            </div>
                            <div class="pitch-item">
                                <label for="pitchEyeRight">Œil droit (°)</label>
                                <input id="pitchEyeRight" type="range" min="-45" max="45" value="0" />
                                <span class="pitch-value">0°</span>
                            </div>
                            <div class="pitch-item">
                                <label for="pitchNeck">Cou (°)</label>
                                <input id="pitchNeck" type="range" min="-45" max="45" value="0" />
                                <span class="pitch-value">0°</span>
                            </div>
                        </div>
                    </div>
                </details>
            </section>
        </div>
    </div>
    <button id="leftPanelToggle" class="panel-toggle left-panel-toggle" type="button"
        aria-label="Ouvrir les commandes de redémarrage">
        <span class="toggle-icon">☰</span>
    </button>

    <div id="sidePanel" class="side-panel" aria-hidden="true">
        <div class="side-panel-content">
            <h2>Logs &amp; Status</h2>

            <section class="panel-section">
                <h3>Statut technique</h3>
                <details class="accordion-item slim" open>
                    <summary>
                        <span>État lecture</span>
                        <span id="badgeStatePanel" class="badge">—</span>
                    </summary>
                    <div class="accordion-content">
                        <pre id="statusBox" class="status-box"></pre>
                    </div>
                </details>
            </section>

            <section class="panel-section">
                <h3>Logs en direct</h3>
                <iframe src="/static/logs.html" title="Logs servo" class="logs-frame panel-logs-frame"></iframe>
            </section>
        </div>
    </div>
    <button id="sidePanelToggle" class="panel-toggle side-panel-toggle" type="button" aria-label="Ouvrir les logs">
        <span class="toggle-icon">☰</span>
    </button>

    <script src="/static/app.js"></script>
    <script>
        (function () {
            const sidePanel = document.getElementById("sidePanel");
            const sideToggle = document.getElementById("sidePanelToggle");
            const leftPanel = document.getElementById("leftPanel");
            const leftToggle = document.getElementById("leftPanelToggle");

            const setupPanel = (panelEl, toggleEl) => {
                if (!panelEl || !toggleEl) {
                    return () => { };
                }

                const iconEl = toggleEl.querySelector(".toggle-icon");
                const setState = (isOpen) => {
                    panelEl.classList.toggle("is-open", isOpen);
                    panelEl.setAttribute("aria-hidden", isOpen ? "false" : "true");
                    if (iconEl) {
                        iconEl.textContent = isOpen ? "×" : "☰";
                    }
                };

                setState(false);

                toggleEl.addEventListener("click", () => {
                    const nextState = !panelEl.classList.contains("is-open");
                    setState(nextState);
                });

                return () => setState(false);
            };

            const closeSidePanel = setupPanel(sidePanel, sideToggle);
            const closeLeftPanel = setupPanel(leftPanel, leftToggle);

            document.addEventListener("keydown", (event) => {
                if (event.key !== "Escape") {
                    return;
                }

                let handled = false;

                if (leftPanel && leftPanel.classList.contains("is-open")) {
                    closeLeftPanel();
                    handled = true;
                }

                if (sidePanel && sidePanel.classList.contains("is-open")) {
                    closeSidePanel();
                    handled = true;
                }

                if (handled) {
                    event.preventDefault();
                }
            });

            const primaryBadge = document.getElementById("badgeState");
            const panelBadge = document.getElementById("badgeStatePanel");

            if (primaryBadge && panelBadge) {
                const syncBadge = () => {
                    panelBadge.textContent = primaryBadge.textContent || "—";
                    panelBadge.className = primaryBadge.className;
                };

                const observer = new MutationObserver(syncBadge);
                observer.observe(primaryBadge, {
                    characterData: true,
                    childList: true,
                    subtree: true,
                    attributes: true,
                    attributeFilter: ["class"]
                });

                syncBadge();
            }
        })();
    </script>
</body>

</html>